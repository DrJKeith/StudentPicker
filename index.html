<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Picker</title>
    <link rel="manifest" href="#" id="manifest-placeholder">
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Student Picker">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f2f2f7;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 28px;
            color: #000;
            font-weight: 600;
        }

        .class-selector {
            margin-bottom: 20px;
        }

        .segmented-control {
            display: flex;
            background: #e5e5ea;
            border-radius: 8px;
            padding: 2px;
        }

        .segment {
            flex: 1;
            padding: 8px 16px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .segment.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-weight: 500;
        }

        .student-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .selected-student {
            font-size: 32px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 15px;
            word-wrap: break-word;
        }

        .ready-message {
            font-size: 24px;
            color: #8E8E93;
        }

        .attendance-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .attendance-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            background: rgba(142, 142, 147, 0.3);
        }

        .attendance-btn.present {
            background: #34C759;
            color: white;
        }

        .attendance-btn.absent {
            background: #FF3B30;
            color: white;
        }

        .participation-rating {
            background: rgba(142, 142, 147, 0.1);
            padding: 15px;
            border-radius: 15px;
            margin-top: 10px;
        }

        .participation-rating h3 {
            font-size: 18px;
            margin-bottom: 10px;
            text-align: center;
        }

        .rating-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .rating-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            min-width: 90px;
            background: rgba(142, 142, 147, 0.3);
            transition: all 0.2s ease;
        }

        .rating-btn .score {
            font-size: 20px;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .rating-btn .label {
            font-size: 12px;
            display: block;
        }

        .rating-btn.score-0 {
            background: #FF9500;
            color: white;
        }

        .rating-btn.score-1 {
            background: #007AFF;
            color: white;
        }

        .rating-btn.score-2 {
            background: #34C759;
            color: white;
        }

        .spacer {
            flex-grow: 1;
        }

        .student-count {
            text-align: center;
            font-size: 14px;
            color: #8E8E93;
            margin-bottom: 5px;
        }

        .not-called-count {
            text-align: center;
            font-size: 14px;
            color: #007AFF;
            margin-bottom: 15px;
        }

        .all-called {
            text-align: center;
            font-size: 14px;
            color: #34C759;
            margin-bottom: 15px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pick-button {
            padding: 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pick-button:disabled {
            background: #8E8E93;
            cursor: not-allowed;
        }

        .secondary-buttons {
            display: flex;
            gap: 10px;
        }

        .reset-button {
            flex: 1;
            padding: 14px;
            background: #FF9500;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .export-button {
            flex: 1;
            padding: 14px;
            background: #34C759;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .export-button:disabled {
            background: #8E8E93;
            cursor: not-allowed;
        }

        .file-upload {
            margin-top: 20px;
            padding: 20px;
            border: 2px dashed #007AFF;
            border-radius: 10px;
            text-align: center;
            background: #f8f9ff;
        }

        .file-upload.hidden {
            display: none;
        }

        .upload-button {
            padding: 10px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }

        .file-input {
            display: none;
        }

        .setup-instructions {
            font-size: 14px;
            color: #8E8E93;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Student Picker</h1>
        </div>

        <div class="class-selector">
            <div class="segmented-control">
                <button class="segment active" data-class="355">355</button>
                <button class="segment" data-class="334">334</button>
            </div>
        </div>

        <div class="student-display">
            <div id="studentArea">
                <div class="ready-message">Ready to pick a student!</div>
            </div>
        </div>

        <div class="spacer"></div>

        <div id="statusInfo">
            <div class="student-count" id="studentCount">0 students loaded.</div>
        </div>

        <div class="action-buttons">
            <button class="pick-button" id="pickButton" disabled>Pick a Random Student</button>
            
            <div class="secondary-buttons">
                <button class="reset-button" id="resetButton">Reset Selection Pool</button>
                <button class="export-button" id="exportButton" disabled>Export Data</button>
            </div>
        </div>

        <div class="file-upload" id="fileUpload">
            <div class="setup-instructions">
                First time setup: Upload your CSV files for each class<br>
                Format: lastname,firstname (one per line)
            </div>
            <label for="file355" class="upload-button">Upload 355 Class CSV</label>
            <input type="file" id="file355" class="file-input" accept=".csv">
            
            <label for="file334" class="upload-button">Upload 334 Class CSV</label>
            <input type="file" id="file334" class="file-input" accept=".csv">
        </div>
    </div>

    <script>
        class StudentPicker {
            constructor() {
                this.students = [];
                this.selectedStudent = null;
                this.selectedClass = '355';
                this.classData = {};
                this.participationRecords = [];
                
                this.initializeEventListeners();
                this.loadFromStorage();
                this.updateUI();
            }

            initializeEventListeners() {
                // Class selector
                document.querySelectorAll('.segment').forEach(segment => {
                    segment.addEventListener('click', (e) => {
                        this.selectClass(e.target.dataset.class);
                    });
                });

                // Pick button
                document.getElementById('pickButton').addEventListener('click', () => {
                    this.pickRandomStudent();
                });

                // Reset button
                document.getElementById('resetButton').addEventListener('click', () => {
                    this.resetCalledOnStatus();
                });

                // Export button
                document.getElementById('exportButton').addEventListener('click', () => {
                    this.exportData();
                });

                // File uploads
                document.getElementById('file355').addEventListener('change', (e) => {
                    this.handleFileUpload(e, '355');
                });
                
                document.getElementById('file334').addEventListener('change', (e) => {
                    this.handleFileUpload(e, '334');
                });
            }

            selectClass(className) {
                document.querySelectorAll('.segment').forEach(seg => {
                    seg.classList.remove('active');
                });
                document.querySelector(`[data-class="${className}"]`).classList.add('active');
                
                this.selectedClass = className;
                this.selectedStudent = null;
                this.students = this.classData[className] || [];
                this.updateUI();
            }

            pickRandomStudent() {
                const notCalledOn = this.students.filter(s => !s.hasBeenCalledOn);
                
                if (notCalledOn.length === 0) {
                    // Everyone has been called, reset and pick from everyone
                    this.resetCalledOnStatus();
                    const randomIndex = Math.floor(Math.random() * this.students.length);
                    this.selectedStudent = this.students[randomIndex];
                    this.students[randomIndex].hasBeenCalledOn = true;
                } else {
                    // Pick from students who haven't been called
                    const randomIndex = Math.floor(Math.random() * notCalledOn.length);
                    this.selectedStudent = notCalledOn[randomIndex];
                    
                    // Mark as called in main array
                    const mainIndex = this.students.findIndex(s => s.id === this.selectedStudent.id);
                    this.students[mainIndex].hasBeenCalledOn = true;
                }
                
                this.saveToStorage();
                this.updateUI();
            }

            resetCalledOnStatus() {
                this.students.forEach(student => {
                    student.hasBeenCalledOn = false;
                    student.isPresent = null;
                    student.participationScore = null;
                });
                this.selectedStudent = null;
                this.saveToStorage();
                this.updateUI();
            }

            markAttendance(isPresent) {
                if (!this.selectedStudent) return;
                
                const index = this.students.findIndex(s => s.id === this.selectedStudent.id);
                if (index !== -1) {
                    this.students[index].isPresent = isPresent;
                    this.selectedStudent = this.students[index];
                    
                    if (!isPresent) {
                        this.students[index].participationScore = null;
                    }
                    
                    this.recordParticipation(this.students[index]);
                    this.saveToStorage();
                    this.updateUI();
                }
            }

            rateParticipation(score) {
                if (!this.selectedStudent || this.selectedStudent.isPresent !== true) return;
                
                const index = this.students.findIndex(s => s.id === this.selectedStudent.id);
                if (index !== -1) {
                    this.students[index].participationScore = score;
                    this.selectedStudent = this.students[index];
                    
                    this.recordParticipation(this.students[index]);
                    this.saveToStorage();
                    this.updateUI();
                }
            }

            recordParticipation(student) {
                if (student.isPresent === null) return;
                
                const record = {
                    date: new Date().toISOString(),
                    className: this.selectedClass,
                    studentName: student.fullName,
                    isPresent: student.isPresent,
                    participationScore: student.participationScore
                };
                
                this.participationRecords.push(record);
                this.saveToStorage();
            }

            exportData() {
                if (this.participationRecords.length === 0) return;
                
                let csv = "Date,Time,Class,Student Name,Present,Participation Score\n";
                
                this.participationRecords.forEach(record => {
                    const date = new Date(record.date);
                    const dateStr = date.toLocaleDateString('en-US');
                    const timeStr = date.toLocaleTimeString('en-US');
                    const present = record.isPresent ? "Yes" : "No";
                    const score = record.participationScore !== null ? record.participationScore : "";
                    
                    csv += `${dateStr},${timeStr},${record.className},${record.studentName},${present},${score}\n`;
                });
                
                // Create download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `participation_data_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('File downloaded successfully!');
            }

            async handleFileUpload(event, className) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const students = this.parseCSV(text);
                    this.classData[className] = students;
                    
                    this.saveToStorage();
                    
                    if (className === this.selectedClass) {
                        this.students = students;
                        this.selectedStudent = null;
                        this.updateUI();
                    }
                    
                    if (this.classData['355'] && this.classData['334']) {
                        document.getElementById('fileUpload').classList.add('hidden');
                    }
                    
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            }

            parseCSV(text) {
                const lines = text.split('\n');
                const students = [];
                
                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;
                    
                    const columns = line.split(',');
                    if (columns.length >= 2) {
                        const lastName = columns[0].trim();
                        const firstName = columns[1].trim();
                        const fullName = `${firstName} ${lastName}`;
                        students.push({
                            id: this.generateId(),
                            fullName: fullName,
                            isPresent: null,
                            participationScore: null,
                            hasBeenCalledOn: false
                        });
                    }
                }
                
                return students;
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            loadFromStorage() {
                const stored = localStorage.getItem('studentPicker_classData');
                if (stored) {
                    this.classData = JSON.parse(stored);
                    this.students = this.classData[this.selectedClass] || [];
                    
                    if (this.classData['355'] && this.classData['334']) {
                        document.getElementById('fileUpload').classList.add('hidden');
                    }
                }
                
                const records = localStorage.getItem('studentPicker_participationRecords');
                if (records) {
                    this.participationRecords = JSON.parse(records);
                }
            }

            saveToStorage() {
                this.classData[this.selectedClass] = this.students;
                localStorage.setItem('studentPicker_classData', JSON.stringify(this.classData));
                localStorage.setItem('studentPicker_participationRecords', JSON.stringify(this.participationRecords));
            }

            updateUI() {
                const studentArea = document.getElementById('studentArea');
                
                if (this.selectedStudent) {
                    studentArea.innerHTML = `
                        <div class="selected-student">${this.selectedStudent.fullName}</div>
                        <div class="attendance-buttons">
                            <button class="attendance-btn ${this.selectedStudent.isPresent === true ? 'present' : ''}" 
                                    onclick="app.markAttendance(true)">
                                âœ“ Present
                            </button>
                            <button class="attendance-btn ${this.selectedStudent.isPresent === false ? 'absent' : ''}" 
                                    onclick="app.markAttendance(false)">
                                âœ— Absent
                            </button>
                        </div>
                        ${this.selectedStudent.isPresent === true ? `
                            <div class="participation-rating">
                                <h3>Rate Answer:</h3>
                                <div class="rating-buttons">
                                    <button class="rating-btn ${this.selectedStudent.participationScore === 0 ? 'score-0' : ''}" 
                                            onclick="app.rateParticipation(0)">
                                        <span class="score">0</span>
                                        <span class="label">Unprepared</span>
                                    </button>
                                    <button class="rating-btn ${this.selectedStudent.participationScore === 1 ? 'score-1' : ''}" 
                                            onclick="app.rateParticipation(1)">
                                        <span class="score">1</span>
                                        <span class="label">Good</span>
                                    </button>
                                    <button class="rating-btn ${this.selectedStudent.participationScore === 2 ? 'score-2' : ''}" 
                                            onclick="app.rateParticipation(2)">
                                        <span class="score">2</span>
                                        <span class="label">Excellent</span>
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    `;
                } else {
                    studentArea.innerHTML = '<div class="ready-message">Ready to pick a student!</div>';
                }


                // Update not called count
                const statusInfo = document.getElementById('statusInfo');
                const notCalledCount = this.students.filter(s => !s.hasBeenCalledOn).length;
                
                let statusHTML = `<div class="student-count" id="studentCount">${this.students.length} students loaded.</div>`;
                
                if (notCalledCount > 0) {
                    statusHTML += `<div class="not-called-count">${notCalledCount} student(s) not yet called on.</div>`;
                } else if (this.students.length > 0) {
                    statusHTML += `<div class="all-called">All students have been called on!</div>`;
                }
                
                statusInfo.innerHTML = statusHTML;

                // Update button states
                document.getElementById('pickButton').disabled = this.students.length === 0;
                document.getElementById('exportButton').disabled = this.participationRecords.length === 0;
            }
        }

        // Initialize the app - FIXED: Wait for DOM to load
        window.addEventListener('DOMContentLoaded', () => {
            window.app = new StudentPicker();
        });

        // PWA manifest
        const manifestData = {
            name: "Student Picker",
            short_name: "Student Picker",
            description: "Random student selector with attendance and participation tracking",
            start_url: "/",
            display: "standalone",
            background_color: "#f2f2f7",
            theme_color: "#007AFF",
            icons: [
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23007AFF'/%3E%3Ctext x='50' y='65' text-anchor='middle' fill='white' font-size='40'%3EðŸ“š%3C/text%3E%3C/svg%3E",
                    sizes: "192x192",
                    type: "image/svg+xml"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').href = manifestURL;
    </script>
</body>
</html>
